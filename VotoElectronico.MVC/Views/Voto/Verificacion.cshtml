@{
    ViewData["Title"] = "Verificación de Votante";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h3><i class="fas fa-shield-alt"></i> Sistema de Verificación de Votante</h3>
                    <p class="mb-0">Juez de Mesa - Validación de Identidad</p>
                </div>
                <div class="card-body p-5">
                    <div id="paso1" class="paso-verificacion">
                        <h4 class="text-center mb-4">
                            <i class="fas fa-id-card"></i> Paso 1: Verificar Cédula
                        </h4>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Instrucciones:</strong><br />
                            1. Solicite la cédula al votante<br />
                            2. Ingrese el número de cédula<br />
                            3. El sistema enviará un código al correo electrónico del votante
                        </div>

                        <div id="errorCedula" class="alert alert-danger d-none"></div>

                        <div class="mb-4">
                            <label for="cedula" class="form-label">
                                <i class="fas fa-id-card"></i> Número de Cédula
                            </label>
                            <input type="text" class="form-control form-control-lg" id="cedula"
                                   placeholder="1234567890" maxlength="10" required>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-primary btn-lg" onclick="generarCodigo()">
                                <i class="fas fa-paper-plane"></i> Generar y Enviar Código
                            </button>
                        </div>
                    </div>

                    <div id="paso2" class="paso-verificacion d-none">
                        <h4 class="text-center mb-4 text-success">
                            <i class="fas fa-check-circle"></i> Código Enviado Exitosamente
                        </h4>

                        <div class="alert alert-success text-center">
                            <i class="fas fa-envelope"></i>
                            Se ha enviado un código de verificación al correo electrónico del votante.<br />
                            <strong>El código es válido por 10 minutos.</strong>
                        </div>

                        <div id="errorCodigo" class="alert alert-danger d-none"></div>

                        <p class="text-center mb-4">
                            Solicite al votante que ingrese el código recibido por email:
                        </p>

                        <div class="mb-4">
                            <label for="codigoVerificacion" class="form-label">
                                <i class="fas fa-key"></i> Código de Verificación (6 caracteres)
                            </label>
                            <input type="text" class="form-control form-control-lg text-center"
                                   id="codigoVerificacion" placeholder="A3K7N2"
                                   maxlength="6" style="letter-spacing: 10px; font-size: 24px;" required>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success btn-lg" onclick="validarCodigo()">
                                <i class="fas fa-check"></i> Validar y Continuar
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="volverPaso1()">
                                <i class="fas fa-arrow-left"></i> Volver
                            </button>
                        </div>
                    </div>

                    <div id="cargando" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3">Procesando...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let cedulaActual = '';

        async function generarCodigo() {
            const cedula = document.getElementById('cedula').value.trim();

            if (!cedula || cedula.length < 10) {
                mostrarError('errorCedula', 'Ingrese un número de cédula válido (10 dígitos)');
                return;
            }

            cedulaActual = cedula;
            mostrarCargando();

            try {
                const response = await fetch('http://localhost:5050/api/Verificacion/GenerarCodigo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cedula)
                });

                const result = await response.json();
                ocultarCargando();

                if (result.success) {
                    // Mostrar paso 2
                    document.getElementById('paso1').classList.add('d-none');
                    document.getElementById('paso2').classList.remove('d-none');
                } else {
                    mostrarError('errorCedula', result.message || 'Error al generar código');
                }
            } catch (error) {
                ocultarCargando();
                mostrarError('errorCedula', 'Error de conexión con el servidor');
            }
        }

        async function validarCodigo() {
            const codigo = document.getElementById('codigoVerificacion').value.trim().toUpperCase();

            if (!codigo || codigo.length !== 6) {
                mostrarError('errorCodigo', 'Ingrese el código de 6 caracteres');
                return;
            }

            mostrarCargando();

            try {
                const response = await fetch('http://localhost:5050/api/Verificacion/ValidarCodigo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cedula: cedulaActual,
                        codigo: codigo
                    })
                });

                const result = await response.json();
                ocultarCargando();

                if (result.success) {
                    // Guardar token temporal y redirigir a votar
                    sessionStorage.setItem('tokenVerificacion', result.data);
                    sessionStorage.setItem('cedulaVerificada', cedulaActual);
                    window.location.href = '/Voto/VotarVerificado';
                } else {
                    mostrarError('errorCodigo', result.message || 'Código incorrecto o expirado');
                }
            } catch (error) {
                ocultarCargando();
                mostrarError('errorCodigo', 'Error de conexión con el servidor');
            }
        }

        function volverPaso1() {
            document.getElementById('paso2').classList.add('d-none');
            document.getElementById('paso1').classList.remove('d-none');
            document.getElementById('cedula').value = '';
            document.getElementById('codigoVerificacion').value = '';
            ocultarError('errorCodigo');
        }

        function mostrarError(idDiv, mensaje) {
            const div = document.getElementById(idDiv);
            div.textContent = mensaje;
            div.classList.remove('d-none');
        }

        function ocultarError(idDiv) {
            const div = document.getElementById(idDiv);
            div.classList.add('d-none');
        }

        function mostrarCargando() {
            document.getElementById('paso1').classList.add('d-none');
            document.getElementById('paso2').classList.add('d-none');
            document.getElementById('cargando').classList.remove('d-none');
        }

        function ocultarCargando() {
            document.getElementById('cargando').classList.add('d-none');
        }

        // Convertir a mayúsculas automáticamente
        document.getElementById('codigoVerificacion')?.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    </script>
}